services:
  runlet_runner_gateway:
    build:
      context: ../../
      dockerfile: build/dev/Dockerfile
    volumes:
      - ../../gateway:/app/gateway
      - ../../runner:/app/runner
      - ../../config.yaml:/app/config.yaml
    hostname: runner_gateway
    networks:
      - runner
      - runlet_external
    command: python gateway/main.py
    env_file:
      - .env

  runlet_runner_redis:
    image: redis:8.4.0-alpine
    hostname: redis
    env_file:
      - .env
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - runlet_runner_redis_data:/data
    networks:
      - runner

  runlet_runner_worker:
    build:  
      context: ../../
      dockerfile: build/dev/Dockerfile
    env_file:
      - .env
    command: celery -A gateway.celery_app.celery_app worker --concurrency=8 --loglevel=info --events
    volumes:
      - ../../gateway:/app/gateway
      - ../../runner:/app/runner
      - ../../config.yaml:/app/config.yaml
      - /var/run/docker.sock:/var/run/docker.sock
      - runlet_code_storage:/tmp
    depends_on:
      - runlet_runner_redis
    networks:
      - runner
      - runlet_external

  runlet_runner_flower:
    build:  
      context: ../../
      dockerfile: build/dev/Dockerfile
    env_file:
      - .env
    command: celery -A gateway.celery_app.celery_app flower --basic_auth=${FLOWER_USER}:${FLOWER_PASSWORD}
    volumes:
      - ../../gateway:/app/gateway
      - ../../runner:/app/runner
      - ../../config.yaml:/app/config.yaml
    depends_on:
      - runlet_runner_worker
    ports:
      - "5555:5555"
    networks:
      - runner

volumes:
  runlet_runner_redis_data:
    name: runlet_runner_redis_data
  runlet_code_storage:
    name: runlet_code_storage

networks:
  runlet_external:
    external: true
  runner: